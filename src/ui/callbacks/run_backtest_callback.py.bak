import dash
from dash import Dash, Input, Output, State, ctx
import logging
import time
from src.ui.ids.ids import WizardIDs, SharedComponentIDs, StrategyConfigIDs
from src.core.constants import DEFAULT_STRATEGY_PARAMS

# Configure logging
logger = logging.getLogger(__name__)

def register_run_backtest_callback(app: Dash):
    """
    Register the callback that connects the Run Backtest button in the wizard
    to the backtest trigger store.
    """
    logger.info("Registering Run Backtest button callback...")
    
    @app.callback(
        [
            Output(StrategyConfigIDs.STRATEGY_CONFIG_STORE_MAIN, 'data'),
            Output(SharedComponentIDs.RUN_BACKTEST_TRIGGER_STORE, 'data')
        ],
        Input(WizardIDs.RUN_BACKTEST_BUTTON_WIZARD, 'n_clicks'),
        [
            State(StrategyConfigIDs.STRATEGY_CONFIG_STORE_MAIN, 'data'),
            State(WizardIDs.STRATEGY_DROPDOWN, "value"),
            State(WizardIDs.INITIAL_CAPITAL_INPUT, "value"),
            State(WizardIDs.DATE_RANGE_START_PICKER, "date"),
            State(WizardIDs.DATE_RANGE_END_PICKER, "date"),
            State(WizardIDs.TICKER_DROPDOWN, "value"),
            State(WizardIDs.MAX_POSITION_SIZE_INPUT, "value"),
            State(WizardIDs.STOP_LOSS_INPUT, "value"),
            State(WizardIDs.TAKE_PROFIT_INPUT, "value"),
            State(WizardIDs.COMMISSION_INPUT, "value"),
            State(WizardIDs.SLIPPAGE_INPUT, "value"),
            State(WizardIDs.REBALANCING_FREQUENCY_DROPDOWN, "value"),
            State(WizardIDs.REBALANCING_THRESHOLD_INPUT, "value")
        ],
        prevent_initial_call=True
    )    def on_run_backtest_button_clicked(n_clicks, current_config, strategy_type, initial_capital, 
                                      start_date, end_date, tickers, max_position_size, 
                                      stop_loss, take_profit, commission, slippage, 
                                      rebalancing_frequency, rebalancing_threshold):
        """
        When the Run Backtest button is clicked:
        1. Update the main config store with the latest wizard values
        2. Trigger the backtest by updating the RUN_BACKTEST_TRIGGER_STORE with the current timestamp
        """
        if not n_clicks:
            return dash.no_update, dash.no_update
        
        # Create or update the configuration
        config_data = current_config or {}
        
        # Get strategy parameters from defaults
        strategy_params = {}
        if strategy_type and strategy_type in DEFAULT_STRATEGY_PARAMS:
            strategy_params = DEFAULT_STRATEGY_PARAMS[strategy_type]
        
        # Update with the wizard values
        config_data.update({
            "strategy_type": strategy_type,
            "initial_capital": initial_capital,
            "start_date": start_date,
            "end_date": end_date,
            "tickers": tickers,
            "strategy_params": strategy_params,
            "risk_management": {
                "max_position_size": max_position_size,
                "stop_loss": stop_loss,
                "take_profit": take_profit
            },
            "trading_costs": {
                "commission_bps": commission,
                "slippage_bps": slippage
            },
            "rebalancing": {
                "frequency": rebalancing_frequency,
                "threshold_pct": rebalancing_threshold
            }
        })
        
        # Log what we're doing
        logger.info(f"Run Backtest button clicked. Updated config and triggering backtest.")
        
        # Validate configuration has required fields
        required_fields = ["strategy_type", "tickers", "start_date", "end_date", "initial_capital"]
        missing_fields = [field for field in required_fields if field not in config_data or not config_data[field]]
        
        if missing_fields:
            logger.warning(f"Run Backtest button clicked but config_data is missing required fields: {missing_fields}")
        else:
            logger.info(f"Config validated successfully.")
            
        # Return both the updated config and the trigger value
        return config_data, {"timestamp": time.time(), "source": "wizard"}
